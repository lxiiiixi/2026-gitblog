# é—ªç”µç½‘ç»œæœ¬åœ°å¼€å‘å®æˆ˜ï¼šä»é›¶æ­å»ºåˆ°å®Œæ•´æµ‹è¯•

é—ªç”µç½‘ç»œï¼ˆLightning Networkï¼‰ä½œä¸ºæ¯”ç‰¹å¸çš„ç¬¬äºŒå±‚æ‰©å®¹æ–¹æ¡ˆï¼Œèƒ½å¤Ÿå®ç°å¿«é€Ÿã€ä½æˆæœ¬çš„å¾®æ”¯ä»˜ã€‚æœ¬æ–‡å°†é€šè¿‡æœ¬åœ° regtest ç¯å¢ƒï¼Œä» Bitcoin Core é…ç½®å¼€å§‹ï¼Œé€æ­¥æ­å»ºä¸€ä¸ªå®Œæ•´çš„é—ªç”µç½‘ç»œæµ‹è¯•ç¯å¢ƒï¼Œå¹¶å®ŒæˆèŠ‚ç‚¹åˆ›å»ºã€é€šé“å¼€å¯ã€è½¬è´¦ã€è·¯ç”±ä»¥åŠé€šé“å…³é—­ç­‰æ ¸å¿ƒæ“ä½œã€‚æ— è®ºä½ æ˜¯æƒ³å­¦ä¹ é—ªç”µç½‘ç»œçš„å·¥ä½œåŸç†ï¼Œè¿˜æ˜¯å‡†å¤‡è¿›è¡Œé—ªç”µç½‘ç»œåº”ç”¨å¼€å‘ï¼Œè¿™ç¯‡å®æˆ˜æŒ‡å—éƒ½èƒ½ä¸ºä½ æä¾›æ¸…æ™°çš„æ­¥éª¤å’Œè¯¦ç»†çš„è¯´æ˜ã€‚

---

### ï¼ˆ1ï¼‰å®‰è£…å¹¶é…ç½® Bitcoin Core (Regtest)

2.1 æ‰¾åˆ° `Bitcoin-Qt` çš„ä½ç½®ç„¶åæ‰§è¡Œ

```sh
âœ /Applications/Bitcoin-Qt.app/Contents/MacOS/Bitcoin-Qt -regtest
2026-01-15 11:07:30.373 Bitcoin-Qt[79059:277210658] +[IMKClient subclass]: chose IMKClient_Modern
2026-01-15 11:07:30.373 Bitcoin-Qt[79059:277210658] +[IMKInputSession subclass]: chose IMKInputSession_Modern
```

ä¼šè¿›å…¥ä¸€ä¸ªä¸»ç•Œé¢ï¼Œæ ‡é¢˜æ æ˜¾ç¤º **[regtest]**ã€‚

2.2 å®‰è£… bitcoin

```sh
brew install bitcoin # ä¼šå®‰è£… `bitcoind` å’Œ `bitcoin-cli`

bitcoin-cli --version
```

2.3 æµ‹è¯•é“¾æ¥

```sh
âœ bitcoin-cli -regtest getblockchaininfo
error: timeout on transient error: Could not connect to the server 127.0.0.1:18443

Make sure the bitcoind server is running and that you are connecting to the correct RPC port.
Use "bitcoin-cli -help" for more info.
```

æœ‰é—®é¢˜è¿æ¥ä¸åˆ°ï¼Œéœ€è¦å¢åŠ ä¸€äº›é…ç½®

```sh
âœ cd "/Users/liuxi/Library/Application Support/Bitcoin"

Library/Application Support/Bitcoin 
âœ ls
banlist.json	blocks		debug.log	regtest		wallets
bitcoind.pid	chainstate	peers.dat	settings.json

Library/Application Support/Bitcoin 
âœ nano bitcoin.conf

Library/Application Support/Bitcoin took 1m 15.0s 
âœ ls               
banlist.json	blocks		debug.log	regtest		wallets
bitcoind.pid	chainstate	peers.dat	settings.json

Library/Application Support/Bitcoin 
âœ cat <<EOF > "bitcoin.conf"
regtest=1
server=1
daemon=1
txindex=1
rpcuser=xixi
rpcpassword=lx123123
zmqpubrawblock=tcp://127.0.0.1:28332
zmqpubrawtx=tcp://127.0.0.1:28333
[regtest]
rpcbind=127.0.0.1
rpcallowip=127.0.0.1
rpcport=18443
EOF
```

ç„¶åæ³¨æ„éœ€è¦é‡å¯ä¸€ä¸‹æ‰èƒ½è®©é…ç½®ç”Ÿæ•ˆ

æ£€æŸ¥ä¸€ä¸‹è¿›ç¨‹å’Œè°ƒç”¨æƒ…å†µï¼š

```sh
Library/Application Support/Bitcoin 
âœ ps aux | grep bitcoind                
liuxi            96411   0.0  0.0 410723856   1536 s032  S+   11:23ä¸Šåˆ   0:00.01 grep bitcoind

Library/Application Support/Bitcoin 
âœ bitcoin-cli -regtest getblockchaininfo
{
  "chain": "regtest",
  "blocks": 0,
  "headers": 0,
  "bestblockhash": "0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206",
  "bits": "207fffff",
  "target": "7fffff0000000000000000000000000000000000000000000000000000000000",
  "difficulty": 4.656542373906925e-10,
  "time": 1296688602,
  "mediantime": 1296688602,
  "verificationprogress": 2.119723541501059e-06,
  "initialblockdownload": true,
  "chainwork": "0000000000000000000000000000000000000000000000000000000000000002",
  "size_on_disk": 293,
  "pruned": false,
  "warnings": [
  ]
}
```


### ï¼ˆ2ï¼‰åˆ›å»ºé’±åŒ…å¹¶å……å€¼

æ‰§è¡Œè¿™äº›æŒ‡ä»¤

```sh
# 1. åˆ›å»ºä¸€ä¸ªåä¸º "dev" çš„æœ¬åœ°é’±åŒ…
bitcoin-cli -regtest createwallet "dev"

# 2. ç”Ÿæˆä¸€ä¸ªæ”¶æ¬¾åœ°å€å¹¶å­˜å…¥å˜é‡ ADDR
ADDR=$(bitcoin-cli -regtest getnewaddress)

# 3. ç¬é—´æŒ–æ˜ 101 ä¸ªåŒºå—åˆ°è¿™ä¸ªåœ°å€ï¼ˆå‰ 100 ä¸ªå—çš„å¥–åŠ±å› è§„åˆ™é™åˆ¶æš‚æ—¶ä¸å¯ç”¨ï¼‰
bitcoin-cli -regtest generatetoaddress 101 $ADDR

# 4. ç¡®è®¤ä½™é¢ï¼ˆä½ åº”è¯¥ä¼šçœ‹åˆ° 50.00000000ï¼‰
bitcoin-cli -regtest getbalance
```

æ¯”å¦‚ï¼š

```
Library/Application Support/Bitcoin 
âœ bitcoin-cli -regtest createwallet "dev"
{
  "name": "dev"
}

Library/Application Support/Bitcoin 
âœ ADDR=$(bitcoin-cli -regtest getnewaddress)

Library/Application Support/Bitcoin 
âœ bitcoin-cli -regtest generatetoaddress 101 $ADDR
[
  "5dc81cd5c9624b0f4300eecc1c452972c1a34e30431b2aaa9836249fa49fab7d",
	....
  "67aa0c1ad4d2689f17533490b554f1a70eb53ad5e6515416164b6a906412e9f4"
]

Library/Application Support/Bitcoin took 8.7s 
âœ bitcoin-cli -regtest getbalance
50.00000000
```

### ï¼ˆ3ï¼‰å®‰è£… LND (Lightning Network Daemon)

> https://github.com/lightningnetwork/lnd/blob/master/docs/INSTALL.md#installation

å‰é¢æˆ‘å·²ç»åœ¨æœ¬åœ°ç›´æ¥å®‰è£…äº† bitcoin core å¹¶ä¸”å¯åŠ¨äº† regtest ç¯å¢ƒï¼Œç°åœ¨è¦å®‰è£… lndï¼Œä½†æ˜¯å†³å®šé€šè¿‡ docker å®‰è£…ï¼Œä¹Ÿå°±æ˜¯æˆ‘ç°åœ¨ä¼šé€šè¿‡ docker åˆ†åˆ«å¯åŠ¨ä¸¤ä¸ª lighting network èŠ‚ç‚¹ã€‚

å‰é¢çš„é…ç½®æ–‡ä»¶ `bitcoin.conf` æˆ‘éœ€è¦è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼ˆå¦‚ä¸‹ï¼‰å¹¶é‡å¯ï¼š

```
regtest=1
server=1
daemon=1
txindex=1

rpcuser=xixi
rpcpassword=lx123123

# å…è®¸å¤–éƒ¨è¿æ¥ï¼ˆDocker å®¹å™¨ä¼šè¢«è§†ä¸ºå¤–éƒ¨ IPï¼‰
rpcbind=0.0.0.0
rpcallowip=0.0.0.0/0

# ZMQ é…ç½®ï¼šå¿…é¡»ç»‘å®šåˆ° 0.0.0.0ï¼ŒDocker æ‰èƒ½ç›‘å¬åˆ°
zmqpubrawblock=tcp://0.0.0.0:28332
zmqpubrawtx=tcp://0.0.0.0:28333

[regtest]
rpcbind=127.0.0.1
rpcallowip=127.0.0.1
rpcport=18443
```

ä¸€äº›é¢å¤–çš„æ³¨æ„äº‹é¡¹ï¼Œæœ‰çš„æ—¶å€™å¦‚æœè¦ä¿®æ”¹é…ç½®ï¼Œé‡å¯ç¨‹åºä¼šå‘ç°ä¹‹å‰è®¾ç½®çš„æ“ä½œï¼ˆæ¯”å¦‚åˆ›å»ºäº†çš„é’±åŒ…å’Œä½™é¢ï¼‰åœ¨ app ä¸Šå¹¶ä¸æ˜¾ç¤ºï¼Œéœ€è¦æ‰‹åŠ¨ load ä¸€ä¸‹ï¼Œapp å°±ä¼šæ˜¾ç¤ºã€‚

```sh
âœ bitcoin-cli -regtest getbalance
error code: -18
error message:
No wallet is loaded. Load a wallet using loadwallet or create a new one with createwallet. (Note: A default wallet is no longer automatically created)

âœ bitcoin-cli loadwallet dev
{
  "name": "dev"
}

~/Downloads/ln-regtest on ğŸ³ v28.0.4 
âœ bitcoin-cli -regtest getbalance
50.00000000
```

æ‰¾ä¸€ä¸ªç›®å½•åˆ†åˆ«åˆ›å»ºï¼š

```
mkdir lnd_alice_data lnd_bob_data
```

ä»¥åŠ `docker-compose.yml`

```yml
services:
    alice:
        image: lightninglabs/lnd:v0.18.4-beta
        container_name: lnd-alice
        volumes:
            - ./lnd_alice_data:/root/.lnd
        ports:
            - "10009:10009"
        command: >
            lnd --noseedbackup
            --bitcoin.active --bitcoin.regtest --bitcoin.node=bitcoind
            --bitcoind.rpchost=host.docker.internal:18443 --bitcoind.rpcuser=xixi --bitcoind.rpcpass=lx123123
            --bitcoind.zmqpubrawblock=tcp://host.docker.internal:28332 --bitcoind.zmqpubrawtx=tcp://host.docker.internal:28333
            --rpclisten=0.0.0.0:10009 --listen=0.0.0.0:9735
        extra_hosts:
            - "host.docker.internal:host-gateway"

    bob:
        image: lightninglabs/lnd:v0.18.4-beta
        container_name: lnd-bob
        volumes:
            - ./lnd_bob_data:/root/.lnd
        ports:
            - "10010:10010"
        command: >
            lnd --noseedbackup
            --bitcoin.active --bitcoin.regtest --bitcoin.node=bitcoind
            --bitcoind.rpchost=host.docker.internal:18443 --bitcoind.rpcuser=xixi --bitcoind.rpcpass=lx123123
            --bitcoind.zmqpubrawblock=tcp://host.docker.internal:28332 --bitcoind.zmqpubrawtx=tcp://host.docker.internal:28333
            --rpclisten=0.0.0.0:10010 --listen=0.0.0.0:9736
        extra_hosts:
            - "host.docker.internal:host-gateway"
```

ç›®å½•ä¸‹æ‰§è¡Œ `docker-compose up -d` å¯åŠ¨è¿™ä¸¤ä¸ªå®¹å™¨ã€‚

æ³¨æ„å…¶ä¸­çš„ç”¨æˆ·åå’Œå¯†ç å‚æ•°è¦å¯¹åº”å‰é¢çš„é…ç½®ä¸­è®¾ç½®çš„ï¼Œå¦åˆ™å¯åŠ¨å®¹å™¨è°ƒç”¨ RPC çš„æ—¶å€™ä¼šæŠ¥ 401 é”™è¯¯ã€‚

å…³äº image ç‰ˆæœ¬ï¼Œå°è¯•äº† `lightninglabs/lnd:v0.17.4-beta`ã€`lightninglabs/lnd:v0.18.0-beta`ã€`lightninglabs/lnd:master` éƒ½ä¼šæœ‰ä¸€äº›ä¸å…¼å®¹çš„æŠ¥é”™é—®é¢˜

### ï¼ˆ4ï¼‰éªŒè¯é—ªç”µç½‘ç»œèŠ‚ç‚¹çŠ¶æ€

è¿›å…¥ `lnd-alice` çš„å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤ï¼Œ`lncli` æ˜¯ LND çš„**å‘½ä»¤è¡Œå·¥å…·**ï¼ˆLightning Network Command Line Interfaceï¼‰ã€‚é€šè¿‡ lncli æ¥è¯·æ±‚é—ªç”µç½‘ç»œçš„èŠ‚ç‚¹ã€‚

```sh
âœ docker exec lnd-alice lncli --network regtest getinfo
{
    "version":  "0.18.4-beta commit=v0.18.4-beta",
    "commit_hash":  "ddeb8351684a611f6c27f16f09be75d5c039f08c",
    "identity_pubkey":  "03dd38cddb86584e794c1c3ddf30090650a3814a894a25b8f74cb1d85e4e86e311",
    "alias":  "03dd38cddb86584e794c",
    "color":  "#3399ff",
    "num_pending_channels":  0,
    "num_active_channels":  0,
    "num_inactive_channels":  0,
    "num_peers":  0,
    "block_height":  101,
    "block_hash":  "67aa0c1ad4d2689f17533490b554f1a70eb53ad5e6515416164b6a906412e9f4",
    "best_header_timestamp":  "1768447657",
    "synced_to_chain":  false,
    "synced_to_graph":  false,
    "testnet":  false,
    "chains":  [
        {
            "chain":  "bitcoin",
            "network":  "regtest"
        }
    ],
    "uris":  [],
    "features":  {
        "0":  {
            "name":  "data-loss-protect",
            "is_required":  true,
            "is_known":  true
        },
        "5":  {
            "name":  "upfront-shutdown-script",
            "is_required":  false,
            "is_known":  true
        },
        "7":  {
            "name":  "gossip-queries",
            "is_required":  false,
            "is_known":  true
        },
        "8":  {
            "name":  "tlv-onion",
            "is_required":  true,
            "is_known":  true
        },
        "12":  {
            "name":  "static-remote-key",
            "is_required":  true,
            "is_known":  true
        },
        "14":  {
            "name":  "payment-addr",
            "is_required":  true,
            "is_known":  true
        },
        "17":  {
            "name":  "multi-path-payments",
            "is_required":  false,
            "is_known":  true
        },
        "23":  {
            "name":  "anchors-zero-fee-htlc-tx",
            "is_required":  false,
            "is_known":  true
        },
        "25":  {
            "name":  "route-blinding",
            "is_required":  false,
            "is_known":  true
        },
        "27":  {
            "name":  "shutdown-any-segwit",
            "is_required":  false,
            "is_known":  true
        },
        "30":  {
            "name":  "amp",
            "is_required":  true,
            "is_known":  true
        },
        "31":  {
            "name":  "amp",
            "is_required":  false,
            "is_known":  true
        },
        "45":  {
            "name":  "explicit-commitment-type",
            "is_required":  false,
            "is_known":  true
        },
        "2023":  {
            "name":  "script-enforced-lease",
            "is_required":  false,
            "is_known":  true
        }
    },
    "require_htlc_interceptor":  false,
    "store_final_htlc_resolutions":  false
}
```

å¯¹äº bob åˆ™éœ€è¦æ˜¾ç¤ºæŒ‡å®šç«¯å£å·ï¼Œå¦åˆ™ä¼šé‡åˆ° `[lncli] rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing: dial tcp 127.0.0.1:10009: connect: connection refused"`

```sh
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 getinfo
{
	....
    "identity_pubkey":  "0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d",
    ....
}
```

åœ¨é—ªç”µç½‘ç»œä¸­ï¼Œè½¬è´¦ä¸æ˜¯å‘ç»™â€œåœ°å€â€ï¼Œè€Œæ˜¯å‘ç»™â€œèŠ‚ç‚¹â€ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ **Identity Pubkey**ï¼ˆèº«ä»½å…¬é’¥ï¼‰ã€‚

åˆ†åˆ«è®°å½• alice å’Œ bob çš„ identity_pubkey

```
Alice: 03dd38cddb86584e794c1c3ddf30090650a3814a894a25b8f74cb1d85e4e86e311
Bob: 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d
```

### ï¼ˆ5ï¼‰æ‰§è¡Œè½¬è´¦çš„å‡†å¤‡å·¥ä½œ

5.1 è®© Alice ç”Ÿæˆä¸€ä¸ªæ¯”ç‰¹å¸åœ°å€ã€‚

```sh
âœ docker exec lnd-alice lncli --network regtest newaddress p2wkh
{
    "address":  "bcrt1qp5fhe90lry3kc6gg2ujq7ge90p95euzz2ttc5q"
}
```

å‘½ä»¤è§£é‡Šï¼š`newaddress` æ˜¯åˆ›å»ºåœ°å€çš„æŒ‡ä»¤ï¼›`p2wkh` æ˜¯â€œéš”ç¦»è§è¯ï¼ˆSegWitï¼‰â€åœ°å€ç±»å‹(é—ªç”µç½‘ç»œæ¨èä¸”æ›´çœæ‰‹ç»­è´¹çš„åœ°å€æ ¼å¼)ã€‚

5.2 å›åˆ°å®¿ä¸»æœºç»ˆç«¯ç»™ alice è½¬é’±ï¼š

```sh
âœ bitcoin-cli -regtest send '{"bcrt1qp5fhe90lry3kc6gg2ujq7ge90p95euzz2ttc5q": 10}' null "unset" 1000
{
  "txid": "ce84ade90386cf63ac86e0055c93d0c4b66cb04e1381e9e5d291b8ed4a79405f",
  "complete": true
}
```

å‘½ä»¤æ‹†è§£ï¼š

- `send`: å‘é€å‘½ä»¤
- `{"åœ°å€": é‡‘é¢}`: æ¥æ”¶è€…å­—å…¸ã€‚
- `null`: ä¸æŒ‡å®šç¡®è®¤ç›®æ ‡ã€‚
- `"unset"`: è´¹ç‡ä¼°ç®—æ¨¡å¼ã€‚
- **`1000`**: æ‰‹åŠ¨æŒ‡å®š `fee_rate`ï¼ˆå•ä½æ˜¯ sat/kvBï¼‰ã€‚åœ¨ `regtest` é‡Œï¼Œåªè¦ç»™ä¸ªå…·ä½“æ•°å­—ï¼Œå®ƒå°±ä¸å†éœ€è¦å»â€œä¼°ç®—â€äº†ã€‚

5.3 æŒ– 6 ä¸ªåŒºå—ç¡®ä¿äº¤æ˜“æˆåŠŸç¡®è®¤

```sh
âœ bitcoin-cli -regtest generatetoaddress 6 $(bitcoin-cli -regtest getnewaddress)
[
  "38b290efeaf5c5f647857e6c9044b4ae8a636150d2b746380ce8fdc433283337",
  "70b42a22f8303aab2b6ccfc2f275edd3ba9899c885b9c3dc76d8f4bc305f2363",
  "1765a41883009b20a6bfd0fcc23a96e3a389bf3c900300607d85ae2483cf7d9f",
  "6617a0e5ac976f65b95773d9b0fb600331b03efbab19f7ff104ac216b69f7e2a",
  "1a9bf8d75dab19211cd5f8de656374e4edcc90dd12fbb05248cdd2d1a17583ad",
  "189a70cc4f36bd1ada59119750f3fd81b9ea34e0fee805978303c5aa80195c55"
]
```

5.4 ç¡®è®¤ Alice çš„é’±åŒ…

```sh
âœ docker exec lnd-alice lncli --network regtest walletbalance
{
    "total_balance":  "1000000000",
    "confirmed_balance":  "1000000000",
    "unconfirmed_balance":  "0",
    "locked_balance":  "0",
    "reserved_balance_anchor_chan":  "0",
    "account_balance":  {
        "default":  {
            "confirmed_balance":  "1000000000",
            "unconfirmed_balance":  "0"
        }
    }
}
```

### ï¼ˆ6ï¼‰å¼€å¯é—ªç”µç½‘ç»œé€šé“(Open Channel)

ç°åœ¨ Alice å’Œ Bob éƒ½åœ¨åŒä¸€ä¸ª Docker ç½‘ç»œä¸‹ï¼Œç›´æ¥è®© Alice é“¾æ¥åˆ° Bob çš„å®¹å™¨åç§°ã€‚

```sh
âœ docker exec lnd-alice lncli --network regtest connect 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d@bob:9736
{}
```

è¿™æ„å‘³ç€ Alice å·²ç»åœ¨ç½‘ç»œå±‚æ‰¾åˆ°äº† Bobï¼Œå°±åƒä¸¤ä¸ªæ‰‹æœºå·²ç»è¿ä¸Šäº†åŒä¸€ä¸ª Wi-Fiã€‚

æ¥ä¸‹æ¥å¼€å§‹åˆ›å»ºé€šé“ã€‚

```sh
# Alice å‘èµ·é€šé“æŒ‡ä»¤ => è¿”å›å¼€å¯é€šé“çš„äº¤æ˜“ ID 
âœ docker exec lnd-alice lncli --network regtest openchannel 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d 1000000
{
    "funding_txid": "ad16e8dfa1110275a15a7f609fb5d2be862345acd3e92c4bd4e62abcab55af0b"
}

# ä¸­é—´è¿˜æ˜¯è¿˜å»ä½¿ç”¨ bitcoin-cli -regtest generatetoaddress 6 $(bitcoin-cli -regtest getnewaddress) æŒ‡ä»¤æŒ–çŸ¿ç”Ÿäº§æ–°åŒºå—

# è¿™é‡Œåˆ›å»ºé€šé“æ˜¯éœ€è¦ä¸Šé“¾çš„ï¼Œéœ€è¦ç­‰å¾…é“¾ä¸Šç¡®è®¤ã€‚

# æ‰§è¡ŒæŸ¥è¯¢
âœ docker exec lnd-alice lncli --network regtest listchannels
{
    "channels":  [
        {
            "active":  true,
            "remote_pubkey":  "0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d",
            "channel_point":  "ad16e8dfa1110275a15a7f609fb5d2be862345acd3e92c4bd4e62abcab55af0b:0",
            "chan_id":  "118747255865344",
            "capacity":  "1000000",
            "local_balance":  "996530",
            "remote_balance":  "0",
            "commit_fee":  "3140",
            "commit_weight":  "772",
            "fee_per_kw":  "2500",
            "unsettled_balance":  "0",
            "total_satoshis_sent":  "0",
            "total_satoshis_received":  "0",
            "num_updates":  "0",
            "pending_htlcs":  [],
            "csv_delay":  144,
            "private":  false,
            "initiator":  true,
            "chan_status_flags":  "ChanStatusDefault",
            "local_chan_reserve_sat":  "10000",
            "remote_chan_reserve_sat":  "10000",
            "static_remote_key":  false,
            "commitment_type":  "ANCHORS",
            "lifetime":  "23",
            "uptime":  "23",
            "close_address":  "",
            "push_amount_sat":  "0",
            "thaw_height":  0,
            "local_constraints":  {
                "csv_delay":  144,
                "chan_reserve_sat":  "10000",
                "dust_limit_sat":  "354",
                "max_pending_amt_msat":  "990000000",
                "min_htlc_msat":  "1",
                "max_accepted_htlcs":  483
            },
            "remote_constraints":  {
                "csv_delay":  144,
                "chan_reserve_sat":  "10000",
                "dust_limit_sat":  "354",
                "max_pending_amt_msat":  "990000000",
                "min_htlc_msat":  "1",
                "max_accepted_htlcs":  483
            },
            "alias_scids":  [],
            "zero_conf":  false,
            "zero_conf_confirmed_scid":  "0",
            "peer_alias":  "unable to lookup peer alias: alias for node not found",
            "peer_scid_alias":  "0",
            "memo":  "",
            "custom_channel_data":  ""
        }
    ]
}
# listchannels çš„è¾“å‡ºä¸­æ ¸å¿ƒå­—æ®µåŒ…æ‹¬ï¼š
# "active": true - è¯´æ˜é€šé“å¯ä»¥è½¬è´¦äº†
# "local_balance":  "996530" - è¡¨ç¤º Alice è¿™ç«¯æ‹¥æœ‰çš„ä½™é¢ï¼Œä¹Ÿå°±æ˜¯å¥¹ç›®å‰æœ€é«˜èƒ½å‘ç»™ Bob çš„é’±ã€‚
# "remote_balance": "0": - å› ä¸ºæ˜¯ Alice å‡ºé’±å¼€çš„é€šé“ï¼Œæ‰€ä»¥ Bob é‚£è¾¹æš‚æ—¶è¿˜æ²¡æœ‰é’±ã€‚
```

è¿™é‡Œæ˜¯ Alice å‘èµ·ä¸€ç¬”ç‰¹æ®Šçš„æ¯”ç‰¹å¸é“¾ä¸Šäº¤æ˜“ï¼ŒæŠŠå¥¹é’±åŒ…é‡Œçš„ 1,000,000 èªï¼ˆ0.01 BTCï¼‰é”å®šåœ¨ä¸€ä¸ªç”±å¥¹å’Œ Bob å…±åŒç®¡ç†çš„â€œä¿é™©ç®±â€é‡Œã€‚ä¸€æ—¦è¿™ä¸ªä¿é™©ç®±åœ¨æ¯”ç‰¹å¸é“¾ä¸Šè¢«ç¡®è®¤ï¼ˆæŒ–çŸ¿ï¼‰ï¼Œä»–ä»¬ä¹‹é—´å°±å¯ä»¥è¿›è¡Œæ— æ•°æ¬¡ã€å³æ—¶çš„ã€é›¶æ‰‹ç»­è´¹çš„é—ªç”µæ”¯ä»˜äº†ã€‚

### ï¼ˆ7ï¼‰åœ¨é€šé“å†…æ‰§è¡Œè½¬è´¦

æƒ³è±¡ Bob æ˜¯ä¸€å®¶å’–å•¡åº—ï¼Œä»–è¦æ”¶ Alice 500 èªï¼ˆSatsï¼‰çš„å’–å•¡é’±ï¼Œåæ¥åˆä¹°ä¸€æ¯åˆæ”¯ä»˜äº†ä¸€æ¬¡ã€‚

```sh
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 addinvoice --amt=500 --memo="Coffee_from_Alice"
{
    "r_hash":  "d0b6e82666b475ba8f2905b1134ec76e5e2f14f1df8031a6307e8bd19f41464a",
    "payment_request":  "lnbcrt5u1p5k3frvpp56zmwsfnxk36m4refqkc3xnk8de0z7983m7qrrf3s069ar86pge9qdqugdhkven9v40kvun0d405zmrfvdjscqzzsxqyz5vqsp5km7m50ahwc2rl0u50tjar5afan89qwza7qgszr6njgsdx9fqt4vs9qxpqysgqcxktp7cfnsclmy8d95vnwpjkyvg5nspam3sn7tegga5fw9huhdu3xkhnjr5jdsnk46y9tmxukra630q0vzpzw22qjzy5epme4xnvt6cqyjparq",
    "add_index":  "1",
    "payment_addr":  "b6fdba3fb776143fbf947ae5d1d3a9ecce50385df011010f539220d315205d59"
}

# è¿™é‡Œç”Ÿæˆçš„ payment_request å°±æ˜¯é—ªç”µç½‘ç»œä¸­çš„â€œå‘ç¥¨â€

âœ docker exec lnd-alice lncli --network regtest sendpayment --pay_req=lnbcrt5u1p5k3frvpp56zmwsfnxk36m4refqkc3xnk8de0z7983m7qrrf3s069ar86pge9qdqugdhkven9v40kvun0d405zmrfvdjscqzzsxqyz5vqsp5km7m50ahwc2rl0u50tjar5afan89qwza7qgszr6njgsdx9fqt4vs9qxpqysgqcxktp7cfnsclmy8d95vnwpjkyvg5nspam3sn7tegga5fw9huhdu3xkhnjr5jdsnk46y9tmxukra630q0vzpzw22qjzy5epme4xnvt6cqyjparq --force
+------------+--------------+--------------+--------------+-----+----------+-----------------+----------------------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT        | ROUTE                |
+------------+--------------+--------------+--------------+-----+----------+-----------------+------+------------+--------------+--------------+--------------+-----+----------+-----------------+----------------------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT        | ROUTE                |
+------------+--------------+--------------+--------------+-----+----------+-----------------+----------------------+
| SUCCEEDED  |        0.014 |        0.117 | 500          | 0   |      196 | 118747255865344 | 0248324fbe947bef6ee8 |
+------------+--------------+--------------+--------------+-----+----------+-----------------+----------------------+
Amount + fee:   500 + 0 sat
Payment hash:   d0b6e82666b475ba8f2905b1134ec76e5e2f14f1df8031a6307e8bd19f41464a
Payment status: SUCCEEDED, preimage: e5cc13fcd2d72e11380672ac2ae448b3ee8ae4cdf10a213c137e214c8709f591


âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 addinvoice --amt=500 --memo="Coffee_from_Alice_more_one_cup"
{
    "r_hash":  "f4a0894df166fd284d4329a90c42f728d0ca23f209bb436e6acc0b8790d7b2ee",
    "payment_request":  "lnbcrt5u1p5k3fgspp57jsgjn03vm7jsn2r9x5scshh9rgv5gljpxa5xmn2es9c0yxhkthqdpsgdhkven9v40kvun0d405zmrfvdj47mt0wfj47mmwv40kxatscqzzsxqyz5vqsp5szcp7379cxuna8qm0q6kah7vxt3ex76mqhmu6rllypavfapkx6dq9qxpqysgqk299ptq79tuhgpag45eacd9asejhp8gyztdxh947ske04fes4dyqjqsk3f33q9jnjxlxnu2lx2v2upwnmm643n0wstrhshnk8hxqcmcpyfjdyy",
    "add_index":  "2",
    "payment_addr":  "80b01f47c5c1b93e9c1b78356edfcc32e3937b5b05f7cd0fff207ac4f436369a"
}


âœ docker exec lnd-alice lncli --network regtest listchannels                                                                          
{
    "channels":  [
        {
            .....
            "chan_id":  "118747255865344",
            "capacity":  "1000000",
            "local_balance":  "995530", # ä½™é¢æ¯”æœ€å¼€å§‹ 996530 çš„å‡å°‘äº† 1000
            "remote_balance":  "1000",
            "commit_fee":  "2810",
            ......
        }
    ]
}


âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 listchannels
{
    "channels":  [
        {
            .....
            "capacity":  "1000000",
            "local_balance":  "1000", # bob çš„ä½™é¢å¢åŠ äº† 1000
            "remote_balance":  "995530", # alice ä½™é¢
            .....
        }
    ]
}
```

æ— è®ºä¸­é—´è½¬è´¦å¤šå°‘æ¬¡éƒ½ä¸éœ€è¦é“¾ä¸Šæ“ä½œã€‚

### ï¼ˆ8ï¼‰å°è¯•å†å¢åŠ ä¸€ä¸ªé€šé“å¹¶ä»£ç†è½¬è´¦

å†å¢åŠ ä¸€ä¸ª carol çš„é—ªç”µèŠ‚ç‚¹ï¼Œå¢åŠ ä¸€ä¸ªæ–°çš„ç›®å½•ï¼Œæ‰§è¡Œ `docker-compose up -d` æ›´æ–°å¯åŠ¨

```
    carol:
        image: lightninglabs/lnd:v0.18.4-beta
        container_name: lnd-carol
        volumes:
            - ./lnd_carol_data:/root/.lnd
        ports:
            - "10011:10011"
        command: >
            lnd --noseedbackup
            --bitcoin.active --bitcoin.regtest --bitcoin.node=bitcoind
            --bitcoind.rpchost=host.docker.internal:18443 --bitcoind.rpcuser=xixi --bitcoind.rpcpass=lx123123
            --bitcoind.zmqpubrawblock=tcp://host.docker.internal:28332 --bitcoind.zmqpubrawtx=tcp://host.docker.internal:28333
            --rpclisten=0.0.0.0:10011 --listen=0.0.0.0:9737
        extra_hosts:
            - "host.docker.internal:host-gateway"
```

é‡å¤æ‰§è¡Œå‰é¢çš„æ“ä½œ

1. åˆå§‹åŒ–å¹¶è·å– Carol çš„ Pubkeyã€‚`docker exec lnd-carol lncli --network regtest --rpcserver=localhost:10011 getinfo` å¾—åˆ° Pubkey ä¸º `02c0ed6e8a805c7a94c61dfa00a42508b0f4e8ae9ea029e806b68ce327575f462d`
2. Carol è¿æ¥ Bob å»ºç«‹ä¸€ä¸ªé€šé“ `docker exec lnd-carol lncli --network regtest --rpcserver=localhost:10011 connect 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d@bob:9736`
3. ä¸º Carol ç”Ÿæˆä¸€ä¸ªåœ°å€ `docker exec lnd-carol lncli --network regtest --rpcserver=localhost:10011 newaddress p2wkh`ã€‚å¹¶ä¸”å»å‘é€ä¸€äº›è½¬è´¦ `bitcoin-cli -regtest send '{"bcrt1qwny9jhnlj2xhc0flgwl76yuc2jg9gf0w3ka0q4": 10}' null "unset" 1000` => æŒ–çŸ¿ç¡®è®¤ã€‚
4. Carol å’Œ Bob ä¹‹é—´å»ºç«‹ä¸€ä¸ª 0.1 BTC çš„é€šé“ `docker exec lnd-carol lncli --network regtest --rpcserver=localhost:10011 openchannel 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d 10000000` => æŒ–çŸ¿ç¡®è®¤ã€‚

ç°åœ¨ç½‘ç»œæ‹“æ‰‘æ˜¯ï¼š`Alice --(é€šé“1)-- Bob --(é€šé“2)-- Carol`ã€‚

æ¥ä¸‹æ¥é€šè¿‡ Carol å»ç”Ÿæˆä¸€ä¸ªå‘ç¥¨ï¼ŒæŒ‰ç…§æˆ‘åŸæ¥çš„ç†è§£æ˜¯å¯ä»¥ç›´æ¥æ”¯ä»˜æˆåŠŸï¼Œå¯æ˜¯äº‹æƒ…å¹¶ä¸æ˜¯å¦‚æ­¤ï¼š

```sh
# carol ç”Ÿæˆä¸€ä¸ªå‘ç¥¨
âœ docker exec lnd-carol lncli --network regtest --rpcserver=localhost:10011 addinvoice --amt=2000 --memo="Alice_to_carol_2000"
{
    "r_hash":  "d02452c9cb5e99aae784a1fffafe4fa1a9bb9f6de37f682bfcaa8f6fefbe1f4f",
    "payment_request":  "lnbcrt20u1p5k3vvrpp56qj99jwtt6v64euy58ll4lj05x5mh8mdudlks2lu428klma7ra8sdqlg9kxjcm9ta6x7hmrv9ex7mzlxgcrqvqcqzzsxqyz5vqsp5grush6erw0wckv6uhkh3apn8z3kyl4ykmdq02tqzkuatkc7wdurq9qxpqysgql2up708n8r0wnzstcry42zzk8farzmcahapsc735d978p45h06g9kpyq8xspntdnwzaca90wwfrt5fnxkl3n9uq6mrxd9vahffpnlkcqsh6yg6",
    "add_index":  "1",
    "payment_addr":  "40f90beb2373dd8b335cbdaf1e8667146c4fd496db40f52c02b73abb63ce6f06"
}

# alice å°è¯•æ”¯ä»˜
âœ docker exec lnd-alice lncli --network regtest sendpayment --pay_req=lnbcrt20u1p5k3vvrpp56qj99jwtt6v64euy58ll4lj05x5mh8mdudlks2lu428klma7ra8sdqlg9kxjcm9ta6x7hmrv9ex7mzlxgcrqvqcqzzsxqyz5vqsp5grush6erw0wckv6uhkh3apn8z3kyl4ykmdq02tqzkuatkc7wdurq9qxpqysgql2up708n8r0wnzstcry42zzk8farzmcahapsc735d978p45h06g9kpyq8xspntdnwzaca90wwfrt5fnxkl3n9uq6mrxd9vahffpnlkcqsh6yg6 --force
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT | ROUTE |
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
Amount + fee:   0 + 0 sat
Payment hash:   d02452c9cb5e99aae784a1fffafe4fa1a9bb9f6de37f682bfcaa8f6fefbe1f4f
Payment status: FAILED, reason: FAILURE_REASON_NO_ROUTE
[lncli] FAILED
```

å‘ç°å¤±è´¥äº†ï¼Œé”™è¯¯ä¿¡æ¯æ˜¯ `FAILURE_REASON_NO_ROUTE`ï¼ˆæ‰¾ä¸åˆ°è·¯ç”±ï¼‰ã€‚

ç°åœ¨çš„æƒ…å†µæ˜¯å¯¹äº **é€šé“ 2 (Carol <-> Bob)** ï¼Œèµ„é‡‘å…¨éƒ¨éƒ½åœ¨ Carol ä¾§ã€‚

æ¯”å¦‚å¯ä»¥æŸ¥çœ‹ bob çš„é€šé“ä½™é¢ï¼š

```sh
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 listchannels
{
    "channels":  [
        { # bob - carol é€šé“
            "capacity":  "10000000", # 0.1BTC
            "local_balance":  "0", # é€šé“å†… bob ä½™é¢
            "remote_balance":  "9996530", # é€šé“å†… carol ä½™é¢
        },
        { # bob - alice é€šé“
            "capacity":  "1000000", # 0.01BTC
            "local_balance":  "1000", # é€šé“å†… bob ä½™é¢
            "remote_balance":  "995530", # é€šé“å†… alice ä½™é¢
        }
    ]
}
```

å¯¹äº Bob æ¥è¯´: ä»–åœ¨ä¸ Carol çš„é€šé“é‡Œ local_balance æ˜¯ 0ã€‚

Alice ç»™ Carol å‘é’±ï¼Œè·¯å¾„æ˜¯ `Alice -> Bob -> Carol`ã€‚ è¿™æ„å‘³ç€ Bob å¿…é¡»ä»ä»–è·Ÿ Carol çš„é€šé“é‡Œï¼ŒæŠŠå±äºä»–çš„é’±æ¨ç»™ Carolã€‚ä½†ç°åœ¨ Bob åœ¨é‚£ä¸ªé€šé“é‡Œ**æ²¡é’±ï¼ˆä½™é¢ä¸º 0ï¼‰**ï¼Œæ‰€ä»¥ä»–æ²¡æ³•æ›¿ Alice è½¬å‘è¿™ç¬”é’±ã€‚

ç°åœ¨æœ‰ä¸¤ç§æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

Aï¼šè®© Bob ç”¨ä¸€äº›èµ„é‡‘ä¸»åŠ¨å¼€å¯ä¸€ä¸ªåˆ° Carol çš„é€šé“ï¼Œç¡®ä¿è‡ªå·±çš„ local_balance æœ‰ä½™é¢ã€‚

Bï¼šè®© Carol å…ˆç»™ Bob é’±ï¼Œè®© Bob æœ‰ä½™é¢ï¼Œä¹‹å Alice å†å‘é’±ç»™ Carol å°±èƒ½æˆåŠŸã€‚

è¿™é‡Œæˆ‘ç”¨æ–¹æ¡ˆ B å°è¯•ï¼š

```sh
# Bob å¼€å¯å‘ç¥¨
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 addinvoice --amt=5000 --memo="Shift_liquidity"
{
    "r_hash":  "9a62c0e095df152bb2a2de3d2da129057f09078a8f45d38b50745ceabe2fd185",
    "payment_request":  "lnbcrt50u1p5k3dzgpp5nf3vpcy4mu2jhv4zmc7jmgffq4lsjpu23aza8z6sw3ww40306xzsdqc2d5xjen5takxjut4d9jxjarecqzzsxqyz5vqsp5d6ftuzjjm500x6jtnee6uumdt3d5e34ccqfymmk7xntkzw6wfdaq9qxpqysgqj9u5wayxc67x455dudpw7d7jjtsdfj7jzlcd488ylzlvj7gntz4phwkpehntp4md3pjjlrlmf2lvf8qe5j5plkkqu4a4mlvx0d0g0vcq6wn4mz",
    "add_index":  "3",
    "payment_addr":  "6e92be0a52dd1ef36a4b9e73ae736d5c5b4cc6b8c0124deede34d7613b4e4b7a"
}

# Carol æ”¯ä»˜ç»™ Bob
âœ docker exec lnd-carol lncli --network regtest --rpcserver=localhost:10011 sendpayment --pay_req=lnbcrt50u1p5k3dzgpp5nf3vpcy4mu2jhv4zmc7jmgffq4lsjpu23aza8z6sw3ww40306xzsdqc2d5xjen5takxjut4d9jxjarecqzzsxqyz5vqsp5d6ftuzjjm500x6jtnee6uumdt3d5e34ccqfymmk7xntkzw6wfdaq9qxpqysgqj9u5wayxc67x455dudpw7d7jjtsdfj7jzlcd488ylzlvj7gntz4phwkpehntp4md3pjjlrlmf2lvf8qe5j5plkkqu4a4mlvx0d0g0vcq6wn4mz --force
+------------+--------------+--------------+--------------+-----+----------+-----------------+----------------------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT        | ROUTE                |
+------------+--------------+--------------+--------------+-----+----------+-----------------+----------------------+
| SUCCEEDED  |        0.020 |        0.122 | 5000         | 0   |      205 | 131941395398656 | 0248324fbe947bef6ee8 |
+------------+--------------+--------------+--------------+-----+----------+-----------------+----------------------+
Amount + fee:   5000 + 0 sat
Payment hash:   9a62c0e095df152bb2a2de3d2da129057f09078a8f45d38b50745ceabe2fd185
Payment status: SUCCEEDED, preimage: 258f1014ffdf2919027dc454c75cd6d5b5695331b265437b37bf582e5a9620d1
```

å†æ‰§è¡Œå‰é¢é‚£ä¸ªæŒ‡ä»¤ï¼Œç»“æœè¿˜æ˜¯åŒæ ·çš„ FAILURE_REASON_NO_ROUTE æ“ä½œã€‚ä¸ºä»€ä¹ˆï¼Ÿ

åœ¨é—ªç”µç½‘ç»œä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´ä¼šäº’ç›¸å¹¿æ’­é€šé“çš„çŠ¶æ€ã€‚å½“ Carol ä»˜é’±ç»™ Bob åï¼ŒBob ä¸ Carol ä¹‹é—´çš„é€šé“çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯ï¼ŒBob éœ€è¦æŠŠè¿™ä¸ªæ–°çŠ¶æ€å¹¿æ’­ç»™ Aliceã€‚åœ¨ `regtest` ç¯å¢ƒä¸‹ï¼Œåªæœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¿™ç§å¹¿æ’­ï¼ˆGossipï¼‰æœ‰æ—¶ä¸ä¼šç«‹å³è§¦å‘ã€‚Alice çš„èŠ‚ç‚¹åœ¨è®¡ç®—è·¯å¾„æ—¶ï¼Œä¾ç„¶è®¤ä¸º Bob åˆ° Carol çš„è·¯å¾„æ˜¯ä½™é¢ä¸è¶³çš„ã€‚

ä¸ºäº†é¿å…å­˜åœ¨æ˜¯å› ä¸ºè¿‡æœŸçš„åŸå› ï¼Œæˆ‘ç”¨ carol é‡æ–°ç”Ÿæˆäº†ä¸€ä¸ªå‘ç¥¨ï¼Œalice æ”¯ä»˜çš„æ—¶å€™ä¾ç„¶ä¸è¡Œã€‚

è¿˜å°è¯•æ‰§è¡Œäº†é‡è¿ï¼Œä¾ç„¶ä¸è¡Œã€‚

```sh
âœ docker exec lnd-alice lncli --network regtest disconnect 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d
{}

âœ docker exec lnd-alice lncli --network regtest connect 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d@bob:9736
{}

âœ docker exec lnd-alice lncli --network regtest sendpayment --pay_req=lnbcrt1u1p5k3wyvpp5uv6mxxpywz62at4sty4pwmqlxrz2t85q3pughmpdfj8qt3p4x87qdq4fejhwh6sv96xsh65v4ehgcqzzsxqyz5vqsp5732mk55xd7vd85p4wzgcaq3qn3r6swv4e4vt0syjhknny6wfz2ys9qxpqysgqlef74caatmclcr0ff7s5e2hsvuqh77w7qz67j0ajtmnvnwspwazz4nkvx5k7qw9wc045r642nghdd0728fe2p9x0jn44yy0chndrescpk9umwm --force
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT | ROUTE |
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
Amount + fee:   0 + 0 sat
Payment hash:   e335b3182470b4aeaeb0592a176c1f30c4a59e8088788bec2d4c8e05c43531fc
Payment status: FAILED, reason: FAILURE_REASON_NO_ROUTE
[lncli] FAILED
```

é€šè¿‡ `docker exec lnd-alice lncli --network regtest describegraph` è¿”å›çš„ nodes åˆ—è¡¨ä¸­æ²¡æœ‰ carol çš„æ•°æ®ï¼Œåªæœ‰ bob å’Œ alice è‡ªå·±çš„ã€‚

æ‰§è¡Œ `docker exec lnd-alice lncli --network regtest connect 02c0ed6e8a805c7a94c61dfa00a42508b0f4e8ae9ea029e806b68ce327575f462d@carol:9737` ï¼Œè®© Alice ç›´æ¥å»æ¡æ‰‹ Carolã€‚å†æ‰§è¡Œä¸Šé¢çš„æŒ‡ä»¤å°±ä¼šå‘ç°æ–°å¢äº† carol çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œä»¥åŠä¸€ä¸ªæ–°çš„é€šé“ã€‚

å¹¶ä¸”æŸ¥è¯¢è·Ÿ carol çš„è·¯å¾„æ˜¯å¯ä»¥æ‰¾åˆ°çš„ï¼š

```sh
âœ docker exec lnd-alice lncli --network regtest queryroutes --dest=02c0ed6e8a805c7a94c61dfa00a42508b0f4e8ae9ea029e806b68ce327575f462d --amt=100
{
    "routes":  [
        {
            "total_time_lock":  286,
            "total_fees":  "1",
            "total_amt":  "101",
            "hops":  [
                {
                    "chan_id":  "118747255865344",
                    "chan_capacity":  "1000000",
                    "amt_to_forward":  "100",
                    "fee":  "1",
                    "expiry":  206,
                    "amt_to_forward_msat":  "100000",
                    "fee_msat":  "1000",
                    "pub_key":  "0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d",
                    "tlv_payload":  true,
                    "mpp_record":  null,
                    "amp_record":  null,
                    "custom_records":  {},
                    "metadata":  "",
                    "blinding_point":  "",
                    "encrypted_data":  "",
                    "total_amt_msat":  "0"
                },
                {
                    "chan_id":  "131941395398656",
                    "chan_capacity":  "10000000",
                    "amt_to_forward":  "100",
                    "fee":  "0",
                    "expiry":  206,
                    "amt_to_forward_msat":  "100000",
                    "fee_msat":  "0",
                    "pub_key":  "02c0ed6e8a805c7a94c61dfa00a42508b0f4e8ae9ea029e806b68ce327575f462d",
                    "tlv_payload":  true,
                    "mpp_record":  null,
                    "amp_record":  null,
                    "custom_records":  {},
                    "metadata":  "",
                    "blinding_point":  "",
                    "encrypted_data":  "",
                    "total_amt_msat":  "0"
                }
            ],
            "total_fees_msat":  "1000",
            "total_amt_msat":  "101000",
            "first_hop_amount_msat":  "0",
            "custom_channel_data":  ""
        }
    ],
    "success_prob":  1
}
```

å†æ¬¡å°è¯•ï¼š

```sh
âœ docker exec lnd-alice lncli --network regtest payinvoice -f --pay_req=lnbcrt1u1p5k3wejpp5vxlevy470m8xemp7c6c5c6l5x2ksxlnhenyknsnpuazrwe2wesasdq0fp5kuazl23jhxaqcqzzsxqyz5vqsp5pmq78gmtrl9zz8c7hgvtvtmmcpzd9y52df5kkmat7l5e24jr0w5s9qxpqysgq4zwmkd8dp0uk65dzjlrzj9d8ehfanf04nk9hg7fgqk4tg0wvwj6y9f6ug4nt63pldfq26rdvmgeyr782xjyu82makk5c6kx7hndx3fcpfx2xah
+-------------------------------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
| HTLC_STATE                          | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT        | ROUTE                                      |
+-------------------------------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
| TEMPORARY_CHANNEL_FAILURE @ 1st hop |        0.014 |        0.134 | 100          | 1   |      289 | 118747255865344 | 0248324fbe947bef6ee8->02c0ed6e8a805c7a94c6 |
+-------------------------------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
Amount + fee:   0 + 0 sat
Payment hash:   61bf9612be7ece6cec3ec6b14c6bf432ad037e77ccc969c261e74437654ecc3b
Payment status: FAILED, reason: FAILURE_REASON_NO_ROUTE
[lncli] FAILED
```

è¿™ä¸€è¡Œæç¤ºï¼š `TEMPORARY_CHANNEL_FAILURE @ 1st hop`ã€‚æ„æ€æ˜¯ï¼šAlice å·²ç»æ‰¾åˆ°äº†å» Carol çš„è·¯ï¼ˆç»è¿‡ Bobï¼‰ï¼Œä½†åœ¨å°è¯•è¸å‡º**ç¬¬ä¸€æ­¥**ï¼ˆå³ä» Alice åˆ° Bob çš„é‚£ä¸ªé€šé“ï¼‰æ—¶ï¼ŒBob çš„èŠ‚ç‚¹è¿”å›äº†ä¸€ä¸ªâ€œä¸´æ—¶é€šé“æ•…éšœâ€ã€‚

ä¸ºä»€ä¹ˆæ˜¯ 1st hop æ•…éšœï¼Ÿ

åœ¨é—ªç”µç½‘ç»œä¸­ï¼Œè™½ç„¶ä¹‹å‰æˆåŠŸç»™ Bob ä»˜è¿‡å’–å•¡é’±ï¼Œä½†ç°åœ¨ Alice è¦é€šè¿‡ Bob è½¬å‘ç»™ Carolï¼Œæƒ…å†µå‘ç”Ÿäº†å˜åŒ–ï¼š

- Bob çš„ç­–ç•¥é™åˆ¶ï¼šBob ä½œä¸ºä¸€ä¸ªâ€œä¸­é—´äººâ€ï¼Œä»–éœ€è¦å¯¹è½¬å‘è¡Œä¸ºè¿›è¡Œè¯„ä¼°ã€‚å¦‚æœä»–è®¤ä¸º Alice æä¾›çš„æ”¯ä»˜å‚æ•°ï¼ˆæ¯”å¦‚æ‰‹ç»­è´¹ã€æ—¶é—´é” Timelockï¼‰ä¸ç¬¦åˆä»–çš„è¦æ±‚ï¼Œä»–ä¼šæ‹’ç»è½¬å‘ã€‚
- Regtest çš„åŒºå—åŒæ­¥é—®é¢˜ï¼šè¿™æ˜¯æœ€å¯èƒ½çš„è¯±å› ã€‚ä½ åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­æŒ–äº†å¾ˆå¤šå—ï¼Œå¦‚æœ Bob èŠ‚ç‚¹æ„ŸçŸ¥çš„åŒºå—é«˜åº¦å’Œ Alice æ„ŸçŸ¥çš„åŒºå—é«˜åº¦æœ‰ç»†å¾®å·®å¼‚ï¼ˆå“ªæ€•åªå·® 1 ä¸ªå—ï¼‰ï¼ŒBob å¯èƒ½ä¼šè®¤ä¸ºè¿™ç¬”æ”¯ä»˜çš„â€œè¿‡æœŸæ—¶é—´â€è®¾ç½®ä¸å®‰å…¨ï¼Œä»è€Œæ‹’ç»å¤„ç†ã€‚

æˆ‘æ‰§è¡Œäº†é‡å¯ bob çš„ç¯å¢ƒ

```sh
âœ docker-compose restart bob
[+] Restarting 1/1
 âœ” Container lnd-bob  Started
```

å†æ¬¡æ‰§è¡Œåˆæ˜¯å¦ä¸€ä¸ªé”™è¯¯äº†ï¼š

```sh
âœ docker exec lnd-alice lncli --network regtest payinvoice -f --pay_req=lnbcrt1u1p5k3wejpp5vxlevy470m8xemp7c6c5c6l5x2ksxlnhenyknsnpuazrwe2wesasdq0fp5kuazl23jhxaqcqzzsxqyz5vqsp5pmq78gmtrl9zz8c7hgvtvtmmcpzd9y52df5kkmat7l5e24jr0w5s9qxpqysgq4zwmkd8dp0uk65dzjlrzj9d8ehfanf04nk9hg7fgqk4tg0wvwj6y9f6ug4nt63pldfq26rdvmgeyr782xjyu82makk5c6kx7hndx3fcpfx2xah
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT | ROUTE |
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
+------------+--------------+--------------+--------------+-----+----------+----------+-------+
Amount + fee:   0 + 0 sat
Payment hash:   61bf9612be7ece6cec3ec6b14c6bf432ad037e77ccc969c261e74437654ecc3b
Payment status: FAILED, reason: FAILURE_REASON_INSUFFICIENT_BALANCE
[lncli] FAILED
```

é€šè¿‡ `docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 listchannels` å‘ç° Alice ä¸ Bob çš„è¿æ¥æ–­äº†ï¼ˆä¸ Alice çš„é€šé“çš„ "active": falseï¼‰ï¼Œé€šè¿‡ `docker exec lnd-alice lncli --network regtest connect 0248324fbe947bef6ee80dae3342ebe24bd62cfae49219d3f883e2fada42490e6d@bob:9736` é‡æ–°å»ºç«‹è¿æ¥ã€‚

åç»­æ˜¯è¿™ä¸ªé—®é¢˜æ˜¯æš‚æ—¶æ²¡ç»§ç»­å¤„ç†äº†ï¼Œå› ä¸ºå°è¯•äº†å¾ˆå¤šæ¬¡éƒ½è¿˜æ˜¯å¤±è´¥å‘Šç»ˆã€‚å¥‡æ€ªçš„äº‹æƒ…æ˜¯ç¬¬äºŒå¤©å†å°è¯•æ‰§è¡Œï¼Œå±…ç„¶éƒ½ç›´æ¥æˆåŠŸäº†ï¼š

```sh
âœ docker exec lnd-alice lncli --network regtest payinvoice -f --pay_req=lnbcrt1u1p5k30n7pp5kjwn9gv4rjsyyvt4y6eg5ycyllvztfvwhgeeyguaq8z43tt736xqdqj2e5kxar0wfu47nrpwqcqzzsxqyz5vqsp5sk5u0u3r00mc7dwmvmfwjc8qf7kvusn08dyy582pypfaw78y5fcq9qxpqysgqkx90eg6lfe736mq7xvkce9ry2jfgew9km99j8dtn362zh5lhulg89hswqs6lyxclrq7lkjtfm43jx6jxk6xldzxumcmaey74jv2072qp0w85qu
+------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT        | ROUTE                                      |
+------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
| SUCCEEDED  |        0.017 |        0.221 | 100          | 1   |      300 | 118747255865344 | 0248324fbe947bef6ee8->02c0ed6e8a805c7a94c6 |
+------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
Amount + fee:   100 + 1 sat
Payment hash:   b49d32a1951ca042317526b28a1304ffd825a58eba3392239d01c558ad7e8e8c
Payment status: SUCCEEDED, preimage: 470d031ffa2e1c0aa2f03a6737ca1a081effaa2755a1e0271c7b5c131bad2e2a

~ 
âœ docker exec lnd-alice lncli --network regtest payinvoice -f --pay_req=lnbcrt1u1p5k3wejpp5vxlevy470m8xemp7c6c5c6l5x2ksxlnhenyknsnpuazrwe2wesasdq0fp5kuazl23jhxaqcqzzsxqyz5vqsp5pmq78gmtrl9zz8c7hgvtvtmmcpzd9y52df5kkmat7l5e24jr0w5s9qxpqysgq4zwmkd8dp0uk65dzjlrzj9d8ehfanf04nk9hg7fgqk4tg0wvwj6y9f6ug4nt63pldfq26rdvmgeyr782xjyu82makk5c6kx7hndx3fcpfx2xah
+------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
| HTLC_STATE | ATTEMPT_TIME | RESOLVE_TIME | RECEIVER_AMT | FEE | TIMELOCK | CHAN_OUT        | ROUTE                                      |
+------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
| SUCCEEDED  |        0.012 |        0.216 | 100          | 1   |      300 | 118747255865344 | 0248324fbe947bef6ee8->02c0ed6e8a805c7a94c6 |
+------------+--------------+--------------+--------------+-----+----------+-----------------+--------------------------------------------+
Amount + fee:   100 + 1 sat
Payment hash:   61bf9612be7ece6cec3ec6b14c6bf432ad037e77ccc969c261e74437654ecc3b
Payment status: SUCCEEDED, preimage: c57657b4d7d632fe9e608a9f762187ee5434228cab314c1e88bf45b81d577b99
```

> [!abstract] å¯¹äºè¿™ä¸ªâ€œæ”¾äº†ä¸€æ™šä¸Šè½¬è´¦å°±æˆåŠŸäº†â€çš„ç°è±¡ï¼ŒAI ç»™å‡ºçš„è§£é‡Šå¤§æ¦‚æ˜¯ï¼š
>
> 1. æ ¸å¿ƒåŸå› ï¼šå…«å¦åè®®çš„â€œæœ€ç»ˆä¸€è‡´æ€§â€ (Gossip Protocol & Eventual Consistency)
>    è¿™æ˜¯æœ€ä¸»è¦çš„åŸå› ã€‚é—ªç”µç½‘ç»œæ²¡æœ‰åƒåŒºå—é“¾é‚£æ ·çš„ä¸€ä¸ªâ€œå…¨å±€è´¦æœ¬â€ï¼Œå®ƒä¾èµ–èŠ‚ç‚¹ä¹‹é—´äº’ç›¸â€œä¼ å…«å¦â€ï¼ˆGossipï¼‰æ¥æ›´æ–°ç½‘ç»œåœ°å›¾ã€‚
>
> å‘ç”Ÿäº†ä»€ä¹ˆï¼š
>
> å½“ä½ æ˜¨å¤©åˆšå»ºç«‹ Carol <-> Bob çš„é€šé“ï¼Œæˆ–è€…åˆšç»™ Bob å……å€¼ï¼ˆè§£å†³æµåŠ¨æ€§ï¼‰æ—¶ï¼Œè¿™ä¸ªçŠ¶æ€æ›´æ–°æ˜¯ç”± Bob å‘å‡ºçš„ã€‚
>
> Alice éœ€è¦æ”¶åˆ°è¿™ä¸ªæ›´æ–°ï¼Œæ‰èƒ½åœ¨å¥¹çš„â€œæœ¬åœ°åœ°å›¾â€é‡ŒæŠŠè¿™æ¡è·¯ç”»é€šã€‚
>
> åœ¨ Regtestï¼ˆæœ¬åœ°æµ‹è¯•ç¯å¢ƒï¼‰ä¸­ï¼Œç”±äºåªæœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼Œä¸”æ²¡æœ‰æŒç»­çš„èƒŒæ™¯æµé‡ï¼Œè¿™ç§å¹¿æ’­å¾€å¾€ä¼šæ»åã€‚Alice å¯èƒ½å½“æ—¶â€œæ²¡å¬æ¸…â€æˆ–è€…è¿˜æ²¡æ¥å¾—åŠå¤„ç†è¿™ä¸ªæ›´æ–°ã€‚
>
> è¿‡äº†ä¸€å¤œï¼š
>
> LND ä¼šå®šæœŸï¼ˆé€šå¸¸æ¯éš”å‡ åˆ†é’Ÿæˆ–é‡å¯æ—¶ï¼‰ä¸å¯¹ç­‰èŠ‚ç‚¹è¿›è¡Œå…¨é‡çš„å›¾è°±åŒæ­¥ (Graph Sync)ã€‚
>
> ç»è¿‡ä¸€æ™šä¸Šçš„æ²‰æ·€ï¼ˆæˆ–è€…ä½ é‡å¯äº† Docker/ç”µè„‘ï¼‰ï¼ŒAlice ç»ˆäºä» Bob é‚£é‡ŒåŒæ­¥åˆ°äº†æœ€æ–°çš„ã€å®Œæ•´çš„ç½‘ç»œæ‹“æ‰‘å›¾ã€‚å¥¹å‘ç°ï¼šâ€œå“¦ï¼åŸæ¥ Bob åˆ° Carol çš„è·¯æ—©å°±é€šäº†ï¼Œè€Œä¸”ä½™é¢å……è¶³ï¼â€
>
> 2. éšå½¢æœºåˆ¶ï¼šä»»åŠ¡æ§åˆ¶ä¸­å¿ƒçš„â€œå†·å´æœŸâ€ (Mission Control Decay)
>    LND å†…éƒ¨æœ‰ä¸€ä¸ªéå¸¸æ™ºèƒ½çš„å­ç³»ç»Ÿå« Mission Controlï¼ˆä»»åŠ¡æ§åˆ¶ï¼‰ã€‚å®ƒè´Ÿè´£è®°å½•æ”¯ä»˜çš„æˆè´¥ç»éªŒã€‚
>
> å‘ç”Ÿäº†ä»€ä¹ˆï¼š
>
> æ˜¨å¤©ä½ å°è¯•äº†å‡ åæ¬¡æ”¯ä»˜ï¼Œå¤§éƒ¨åˆ†éƒ½å¤±è´¥äº†ï¼ˆå› ä¸ºå½“æ—¶ Bob æ²¡é’±ï¼Œæˆ–è€…è·¯æ²¡é€šï¼‰ã€‚
>
> Alice çš„ Mission Control ä¼šâ€œè®°ä½â€è¿™ç§å¤±è´¥ã€‚å¥¹ä¼šæ ‡è®°ï¼šâ€œBob è¿™ä¸ªèŠ‚ç‚¹ä¸é è°±ï¼Œé€šè¿‡ä»–å» Carol çš„è·¯æœ€è¿‘æ€»æ˜¯å µæ­»ã€‚â€
>
> å³ä½¿ä½ åæ¥ç»™ Bob å……äº†é’±ï¼Œä¿®å¤äº†æŠ€æœ¯é—®é¢˜ï¼Œä½† Alice çš„â€œå¿ƒç†é˜´å½±â€è¿˜åœ¨ã€‚å¥¹å¯èƒ½ä¼šå› ä¸ºä¹‹å‰çš„å¤±è´¥è®°å½•ï¼Œåœ¨çŸ­æ—¶é—´å†…ç›´æ¥æ‹’ç»å†æ¬¡å°è¯•è¯¥è·¯å¾„ï¼Œæˆ–è€…ç»™äºˆè¯¥è·¯å¾„æä½çš„ä¼˜å…ˆçº§ã€‚
>
> è¿‡äº†ä¸€å¤œï¼š
>
> Mission Control çš„è®°å¿†æ˜¯æœ‰**è¡°å‡æœŸï¼ˆDecay Timeï¼‰**çš„ã€‚
>
> è¿‡äº†ä¸€å¤œï¼Œä¹‹å‰é‚£äº›å¤±è´¥è®°å½•çš„æƒé‡å½’é›¶äº†ã€‚Alice é‡æ–°ä»¥â€œç™½çº¸â€çš„å¿ƒæ€è¯„ä¼°è·¯å¾„ï¼Œå‘ç° Bob ç°åœ¨çš„çŠ¶æ€æ˜¯å®Œç¾çš„ï¼Œäºæ˜¯æœæ–­å°è¯•ï¼Œä¸€å‡»å³ä¸­ã€‚
>
> 3. æ—¶é—´é”ä¸åŒºå—ç¡®è®¤ (Timelock & Confirmations)
>    ä½ æ˜¨å¤©é‡åˆ°çš„ TEMPORARY_CHANNEL_FAILURE å¾€å¾€å’ŒåŒºå—é«˜åº¦æœ‰å…³ã€‚
>
> å‘ç”Ÿäº†ä»€ä¹ˆï¼š
>
> ä½ æ‰‹åŠ¨æŒ–äº†å¾ˆå¤šå—ã€‚æœ‰æ—¶å€™ï¼Œä¸åŒèŠ‚ç‚¹ï¼ˆAlice å’Œ Bobï¼‰å¯¹â€œå½“å‰æœ€æ–°åŒºå—é«˜åº¦â€çš„è®¤çŸ¥ä¼šæœ‰çŸ­æš‚çš„åå·®ã€‚
>
> å¦‚æœ Bob è®¤ä¸ºå½“å‰é«˜åº¦æ˜¯ 105ï¼ŒAlice è®¤ä¸ºæ˜¯ 104ï¼Œä»–ä»¬åœ¨è®¡ç®— HTLCï¼ˆå“ˆå¸Œæ—¶é—´é”åˆçº¦ï¼‰çš„è¶…æ—¶æ—¶é—´æ—¶å°±ä¼šäº§ç”Ÿåˆ†æ­§ï¼Œå¯¼è‡´äº¤æ˜“è¢«æ‹’ã€‚
>
> è¿‡äº†ä¸€å¤œï¼š
>
> æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸æ¯”ç‰¹å¸åº•å±‚èŠ‚ç‚¹ï¼ˆBitcoindï¼‰å®Œå…¨åŒæ­¥ï¼Œå¤§å®¶å¯¹â€œç°åœ¨å‡ ç‚¹äº†ï¼ˆåŒºå—é«˜åº¦ï¼‰â€è¾¾æˆäº†ç»å¯¹å…±è¯†ã€‚

### ï¼ˆ9ï¼‰å…³é—­é€šé“ï¼ˆæ­£å¸¸åå•†ç‰ˆï¼‰

Bob ç»“ç®—ä¸ Alice çš„è´¦å• => Bob å°†å‘èµ·å…³é—­è¯·æ±‚ï¼ŒAlice ä¼šæ”¶åˆ°é€šçŸ¥å¹¶ç­¾ç½²äº¤æ˜“ã€‚

é€šè¿‡ listchannels æ‰¾åˆ° Bob ä¸ Alice ä¹‹é—´çš„ channel_point æ˜¯ `"ad16e8dfa1110275a15a7f609fb5d2be862345acd3e92c4bd4e62abcab55af0b:0"`ã€‚

æ‰€ä»¥æ‰§è¡Œï¼š

```sh
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 closechannel --funding_txid ad16e8dfa1110275a15a7f609fb5d2be862345acd3e92c4bd4e62abcab55af0b --output_index 0
{
    "closing_txid": "346c0aba8104e01355d3fd47158dac3ab064562e149135377a74f12cce078d4c"
}
```

åœ¨é—ªç”µç½‘ç»œå‘èµ·å…³é—­å‘½ä»¤åï¼Œè¿™ç¬”å¯¹è´¦å•ï¼ˆClosing Transactionï¼‰åªæ˜¯è¿›å…¥äº†æ¯”ç‰¹å¸çš„å†…å­˜æ± ï¼ˆMempoolï¼‰ã€‚åœ¨ `regtest` ç¯å¢ƒä¸‹ï¼Œéœ€è¦æ‰‹åŠ¨æŒ–å—æ¥å®Œæˆæœ€ç»ˆç»“ç®—ã€‚

éªŒè¯é“¾ä¸Šèµ„é‡‘ï¼š

```sh
âœ docker exec lnd-alice lncli --network regtest walletbalance
{
    "total_balance":  "999980911",
    "confirmed_balance":  "999980911",
    "unconfirmed_balance":  "0",
    "locked_balance":  "0",
    "reserved_balance_anchor_chan":  "0",
    "account_balance":  {
        "default":  {
            "confirmed_balance":  "999980911",
            "unconfirmed_balance":  "0"
        }
    }
}

~ 
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 walletbalance
{
    "total_balance":  "1202",
    "confirmed_balance":  "1202",
    "unconfirmed_balance":  "0",
    "locked_balance":  "0",
    "reserved_balance_anchor_chan":  "10000",
    "account_balance":  {
        "default":  {
            "confirmed_balance":  "1202",
            "unconfirmed_balance":  "0"
        }
    }
}
```

å¯ä»¥æŸ¥çœ‹è¿™ä¸¤ç¬”äº¤æ˜“çš„æ‰§è¡Œå…·ä½“è¯¦æƒ…ï¼š

```sh
âœ bitcoin-cli -regtest getrawtransaction 346c0aba8104e01355d3fd47158dac3ab064562e149135377a74f12cce078d4c true
{
  "txid": "346c0aba8104e01355d3fd47158dac3ab064562e149135377a74f12cce078d4c",
  "hash": "2db58e88d86b749f0e5973bfa64a1605c91c8acc70e518733480eaef0c244b3d",
  "version": 2,
  "size": 358,
  "vsize": 193,
  "weight": 769,
  "locktime": 0,
  "vin": [
    {
      "txid": "ad16e8dfa1110275a15a7f609fb5d2be862345acd3e92c4bd4e62abcab55af0b",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "",
        "3045022100b55a1038d6c8c0a6f6a695ee71be02c2fc18a4d51dc9097a7c923217105bebcf022059ca5d7410019cd7b5774e45891f06143763d789065c27355e795c82458dbc1901",
        "30440220128bc6af32d3712645ce7735540bc4296927e9714d0ec47125f30effbca5e23802207c0df15c31c4597e6a1d196aa0572128c02919cc94079a943b6cb3fbd8e8900601",
        "522102298a67a01d06ae237477787761a3a4f35f294460b00fac18ae0723b67283dc8f2103518aa22bcdb73ef72c2e759fc8833874eb1fed346ed315da0b393c983034471e52ae"
      ],
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.00001202,
      "n": 0,
      "scriptPubKey": {
        "asm": "1 dfd0ab9b4d8d8592687ad16e93f632cca3c53a1c8103290d3d6d5ad224e6c022",
        "desc": "rawtr(dfd0ab9b4d8d8592687ad16e93f632cca3c53a1c8103290d3d6d5ad224e6c022)#6xaa2et2",
        "hex": "5120dfd0ab9b4d8d8592687ad16e93f632cca3c53a1c8103290d3d6d5ad224e6c022",
        "address": "bcrt1pmlg2hx6d3kzey6r669hf8a3jej3u2wsusypjjrfad4ddyf8xcq3qez0hjd",
        "type": "witness_v1_taproot"
      }
    },
    {
      "value": 0.00989148,
      "n": 1,
      "scriptPubKey": {
        "asm": "1 e9968832f8ed926ae2eeb82083e4dba0b1ce3098afa0b000fa9449314a0d44de",
        "desc": "rawtr(e9968832f8ed926ae2eeb82083e4dba0b1ce3098afa0b000fa9449314a0d44de)#v55gru4h",
        "hex": "5120e9968832f8ed926ae2eeb82083e4dba0b1ce3098afa0b000fa9449314a0d44de",
        "address": "bcrt1paxtgsvhcakfx4chwhqsg8exm5zcuuvyc47stqq86j3ynzjsdgn0qgktlvx",
        "type": "witness_v1_taproot"
      }
    }
  ],
  "hex": "020000000001010baf55abbc2ae6d44b2ce9d3ac452386bed2b59f607f5aa1750211a1dfe816ad0000000000ffffffff02b204000000000000225120dfd0ab9b4d8d8592687ad16e93f632cca3c53a1c8103290d3d6d5ad224e6c022dc170f0000000000225120e9968832f8ed926ae2eeb82083e4dba0b1ce3098afa0b000fa9449314a0d44de0400483045022100b55a1038d6c8c0a6f6a695ee71be02c2fc18a4d51dc9097a7c923217105bebcf022059ca5d7410019cd7b5774e45891f06143763d789065c27355e795c82458dbc19014730440220128bc6af32d3712645ce7735540bc4296927e9714d0ec47125f30effbca5e23802207c0df15c31c4597e6a1d196aa0572128c02919cc94079a943b6cb3fbd8e890060147522102298a67a01d06ae237477787761a3a4f35f294460b00fac18ae0723b67283dc8f2103518aa22bcdb73ef72c2e759fc8833874eb1fed346ed315da0b393c983034471e52ae00000000",
  "blockhash": "640034fac99a2c9601697e2c76bc35324f3a7b6cf92783331702a29990dbb6a3",
  "confirmations": 6,
  "time": 1768529080,
  "blocktime": 1768529080
}

~/Downloads/ln-regtest on ğŸ³ v28.0.4 runs ğŸ™ LLL 
âœ bitcoin-cli -regtest getrawtransaction ad16e8dfa1110275a15a7f609fb5d2be862345acd3e92c4bd4e62abcab55af0b true
{
  "txid": "ad16e8dfa1110275a15a7f609fb5d2be862345acd3e92c4bd4e62abcab55af0b",
  "hash": "1eb68b13056fb5a6a0c5a06162269293d54067c8d60f7477e6ceffae17fa529d",
  "version": 2,
  "size": 247,
  "vsize": 165,
  "weight": 658,
  "locktime": 0,
  "vin": [
    {
      "txid": "ce84ade90386cf63ac86e0055c93d0c4b66cb04e1381e9e5d291b8ed4a79405f",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "3045022100ae2c790e46d17e8932c21ca57e07ba37ac8cadd0fdd8caceeeaaa42a6a1beeec02207cf14f7b8768bbc24c2a150563d5d19b2f179b48b988df65659567ba2dc2a1e201",
        "03bc67125d4ef3f3cf2bd4e649a47717e2ea5eebc9165b3580efbb8daa769018cd"
      ],
      "sequence": 0
    }
  ],
  "vout": [
    {
      "value": 0.01000000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 7f7b049658c1d2e888e15763efc0b3114ab5056ca4c107250a361064176d073b",
        "desc": "addr(bcrt1q0aasf9jcc8fw3z8p2a37ls9nz99t2ptv5nqswfg2xcgxg9mdquasd6fupf)#nmdp285p",
        "hex": "00207f7b049658c1d2e888e15763efc0b3114ab5056ca4c107250a361064176d073b",
        "address": "bcrt1q0aasf9jcc8fw3z8p2a37ls9nz99t2ptv5nqswfg2xcgxg9mdquasd6fupf",
        "type": "witness_v0_scripthash"
      }
    },
    {
      "value": 9.98991763,
      "n": 1,
      "scriptPubKey": {
        "asm": "1 a8c5ada2337c73311227c356051dc8767594cb2ba94309e6b16c730c198ea59c",
        "desc": "rawtr(a8c5ada2337c73311227c356051dc8767594cb2ba94309e6b16c730c198ea59c)#ylx8dncp",
        "hex": "5120a8c5ada2337c73311227c356051dc8767594cb2ba94309e6b16c730c198ea59c",
        "address": "bcrt1p4rz6mg3n03enzy38cdtq28wgwe6efjet49psne43d3escxvw5kwqnm92tw",
        "type": "witness_v1_taproot"
      }
    }
  ],
  "hex": "020000000001015f40794aedb891d2e5e981134eb06cb6c4d0935c05e086ac63cf8603e9ad84ce0000000000000000000240420f00000000002200207f7b049658c1d2e888e15763efc0b3114ab5056ca4c107250a361064176d073b93678b3b00000000225120a8c5ada2337c73311227c356051dc8767594cb2ba94309e6b16c730c198ea59c02483045022100ae2c790e46d17e8932c21ca57e07ba37ac8cadd0fdd8caceeeaaa42a6a1beeec02207cf14f7b8768bbc24c2a150563d5d19b2f179b48b988df65659567ba2dc2a1e2012103bc67125d4ef3f3cf2bd4e649a47717e2ea5eebc9165b3580efbb8daa769018cd00000000",
  "blockhash": "0d8861ae010a57d38c19a868883a60bd2629dd9425009e01ae0afdfa8c126e58",
  "confirmations": 36,
  "time": 1768465120,
  "blocktime": 1768465120
}
```

### ï¼ˆ10ï¼‰å…³é—­é€šé“ï¼ˆå¼ºåˆ¶å…³é—­ç‰ˆï¼‰

> å…³äºé€šé“çš„æ—¶é—´ï¼šæ­£å¸¸ä½¿ç”¨çš„åœºæ™¯ä¸­æ˜¯ **æ²¡æœ‰å¼ºåˆ¶çš„æ—¶é—´é™åˆ¶** çš„ã€‚é—ªç”µç½‘ç»œé€šé“å¯ä»¥**é•¿æœŸä¿æŒå¼€å¯**ï¼Œç†è®ºä¸Šå¯ä»¥æ— é™æœŸä¸å…³é—­ï¼›

ç°åœ¨æ¨¡æ‹Ÿ Carol ç¦»çº¿ä½†æ˜¯ Bob å¸Œæœ›ä¸»åŠ¨å…³é—­çš„åœºæ™¯ã€‚

åœ¨ Carol ç¦»çº¿çš„æƒ…å†µä¸‹ï¼ŒBob æ— æ³•ä¸å¥¹åå•†ï¼ˆCooperative Closeï¼‰ï¼Œåªèƒ½å•æ–¹é¢å°†ä»–è®¤ä¸ºæ­£ç¡®çš„â€œå¯¹è´¦å•â€å‘é€åˆ°é“¾ä¸Šã€‚ä¸ºäº†é˜²æ­¢ Bob æ¬ºè¯ˆï¼Œé—ªç”µç½‘ç»œåè®®ä¼šç»™è¿™ç¬”ç»“ç®—åŠ ä¸Šä¸€ä¸ªæ—¶é—´é”ï¼ˆCSV Delayï¼‰ï¼Œå³ Bob çš„é’±ä¼šè¢«é”å®šä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚ 144 ä¸ªå—ï¼‰ï¼Œè€Œ Carol çš„é’±ï¼ˆå¦‚æœå¥¹åœ¨ç»“ç®—å‰ä¸Šçº¿ï¼‰å¯ä»¥ç«‹å³æ‹¿å›ã€‚



```sh
# æ¨¡æ‹Ÿ Carol ç¦»çº¿
âœ docker stop lnd-carol
lnd-carol

# é€šè¿‡ listchannels æŸ¥è¯¢åˆ° bob å’Œ carol çš„ channel_pointï¼Œç„¶åæ‰§è¡Œå…³é—­
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 closechannel --force --funding_txid aff282f0401a01fbc1c7f32987518e6299288f5dc7577398c9cf8fb012d87b7f --output_index 0
{
    "closing_txid": "9c9996405622c783997bc0c02b19b1a597a960433f3566735bfca83ff8119d08"
}

# è¿™æ—¶å€™äº¤æ˜“ä¼šè¿›å…¥å†…å­˜æ± ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡èŠ‚ç‚¹æŸ¥è¯¢åˆ°è¿™ä¸ªäº¤æ˜“ã€‚

# å¼ºåˆ¶å…³é—­åï¼Œèµ„é‡‘ä¸ä¼šç«‹å³å›åˆ° Bob çš„é’±åŒ…ï¼Œè€Œæ˜¯è¿›å…¥ waiting çŠ¶æ€ã€‚
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 pendingchannels
{
    "total_limbo_balance":  "209800",
    "pending_open_channels":  [],
    "pending_closing_channels":  [],
    "pending_force_closing_channels":  [],
    "waiting_close_channels":  [
        {
            "channel":  {
                "remote_node_pub":  "02c0ed6e8a805c7a94c61dfa00a42508b0f4e8ae9ea029e806b68ce327575f462d",
                "channel_point":  "aff282f0401a01fbc1c7f32987518e6299288f5dc7577398c9cf8fb012d87b7f:0",
                "capacity":  "10000000",
                "local_balance":  "209800",
                "remote_balance":  "9786730",
                "local_chan_reserve_sat":  "100000",
                "remote_chan_reserve_sat":  "100000",
                "initiator":  "INITIATOR_REMOTE",
                "commitment_type":  "ANCHORS",
                "num_forwarding_packages":  "0",
                "chan_status_flags":  "ChanStatusBorked|ChanStatusCommitBroadcasted|ChanStatusLocalCloseInitiator",
                "private":  false,
                "memo":  "",
                "custom_channel_data":  ""
            },
            "limbo_balance":  "209800",
            "commitments":  {
                "local_txid":  "9c9996405622c783997bc0c02b19b1a597a960433f3566735bfca83ff8119d08",
                "remote_txid":  "08e0550d905b2cc8de800bd12f226fdd2b085cfcb2e1df2cb51d5c32d090abc9",
                "remote_pending_txid":  "",
                "local_commit_fee_sat":  "2810",
                "remote_commit_fee_sat":  "2810",
                "remote_pending_commit_fee_sat":  "0"
            },
            "closing_txid":  "9c9996405622c783997bc0c02b19b1a597a960433f3566735bfca83ff8119d08",
            "closing_tx_hex":  ""
        }
    ]
}

# å…¶ä¸­å¯ä»¥è§‚å¯Ÿåˆ° waiting_close_channels ä¸­æœ‰æ­£åœ¨ç­‰å¾…è¢«å…³é—­çš„é€šé“
# maturity_height Bob å¿…é¡»ç­‰åˆ°åŒºå—é“¾è¾¾åˆ°è¿™ä¸ªé«˜åº¦ï¼Œæ‰èƒ½é¢†å›ä»–çš„é’±ã€‚

# æ‰§è¡Œ bitcoin-cli -regtest generatetoaddress 1 $(bitcoin-cli -regtest getnewaddress) æ¥æŒ–ä¸€ä¸ªå—è®©Force Close äº¤æ˜“ç”Ÿæ•ˆ
# ç„¶åå†å»æŸ¥è¯¢ pendingchannelsï¼Œå¯ä»¥çœ‹åˆ°é€šé“è¿›å…¥äº† pending_force_closing_channels åˆ—è¡¨ï¼Œå¹¶ä¸”ä¼šæ˜¾ç¤ºä¸€ä¸ª blocks_til_maturityï¼ˆè·ç¦»èµ„é‡‘è§£å†»è¿˜æœ‰å¤šå°‘ä¸ªå—ï¼‰ã€‚

# å¦‚æœæ­¤æ—¶æŸ¥è¯¢ bob çš„ä½™é¢ï¼Œä¼šå‘ç°å¹¶æ²¡æœ‰å‘ç”Ÿä»»ä½•æ”¹å˜ã€‚

# æš´åŠ›æ‰§è¡ŒæŒ– 1202 ä¸ªå— bitcoin-cli -regtest generatetoaddress 1202 $(bitcoin-cli -regtest getnewaddress)

# æŸ¥è¯¢ bob çš„ä½™é¢ï¼š
âœ docker exec lnd-bob lncli --network regtest --rpcserver=localhost:10010 walletbalance
{
    "total_balance":  "204327",
    "confirmed_balance":  "1202",
    "unconfirmed_balance":  "203125",
    "locked_balance":  "0",
    "reserved_balance_anchor_chan":  "10000",
    "account_balance":  {
        "default":  {
            "confirmed_balance":  "1202",
            "unconfirmed_balance":  "203125"
        }
    }
}
```

---

## æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„å®æˆ˜æ“ä½œï¼Œæˆ‘ä»¬å®Œæˆäº†ä» Bitcoin Core regtest ç¯å¢ƒæ­å»ºåˆ°é—ªç”µç½‘ç»œå®Œæ•´æµ‹è¯•çš„å…¨æµç¨‹ã€‚æ•´ä¸ªè¿‡ç¨‹æ¶µç›–äº†ï¼š

1. **ç¯å¢ƒæ­å»º**ï¼šé…ç½® Bitcoin Core regtest æ¨¡å¼ï¼Œåˆ›å»ºæµ‹è¯•é’±åŒ…å¹¶å……å€¼
2. **èŠ‚ç‚¹éƒ¨ç½²**ï¼šä½¿ç”¨ Docker éƒ¨ç½²å¤šä¸ª LND èŠ‚ç‚¹ï¼ˆAliceã€Bobã€Carolï¼‰
3. **é€šé“ç®¡ç†**ï¼šå¼€å¯é—ªç”µç½‘ç»œé€šé“ï¼Œç†è§£é€šé“ä½™é¢å’ŒæµåŠ¨æ€§çš„é‡è¦æ€§
4. **æ”¯ä»˜ä½“éªŒ**ï¼šåœ¨é€šé“å†…è¿›è¡Œå³æ—¶è½¬è´¦ï¼Œä½“éªŒé—ªç”µç½‘ç»œçš„å¿«é€Ÿæ”¯ä»˜ç‰¹æ€§
5. **è·¯ç”±æ¢ç´¢**ï¼šé€šè¿‡å¤šèŠ‚ç‚¹ç½‘ç»œç†è§£é—ªç”µç½‘ç»œçš„è·¯ç”±æœºåˆ¶å’Œ Gossip åè®®
6. **é€šé“å…³é—­**ï¼šå­¦ä¹ æ­£å¸¸åå•†å…³é—­å’Œå¼ºåˆ¶å…³é—­ä¸¤ç§åœºæ™¯
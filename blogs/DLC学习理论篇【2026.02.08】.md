> 相关文章推荐：
>
> [BTC Study - 谨慎日志合约（DLC）：比特币区块链上的隐形智能合约](https://www.btcstudy.org/2021/11/25/discreet-log-contracts-invisible-smart-contracts-on-the-bitcoin-blockchain/)
>
> [River](https://river.com/learn/terms/d/discreet-log-contract-dlc/)
>
> [谨慎日志合约（DLC）：比特币的可扩展智能合约](https://www.btcstudy.org/2022/08/01/discreet-log-contracts-smart-contracts-for-bitcoin/)

## 基本概念

> 来自：[Bitcoin Optech 对 DLC 对定义](https://bitcoinops.org/en/topics/discreet-log-contracts/)
>
> **Discreet Log Contracts (DLCs)** are a contract protocol where two or more parties agree to exchange money dependent on the outcome of a certain event as determined by an oracle (or several oracles). After the event happens, the oracle publishes a commitment to the outcome of the event that the winning party can use to claim their funds. The oracle doesn’t need to know the terms of the contract (or even that a contract was made).

- 定义
  - DLC 协议（Discreet Log Contracts，隐秘日志合约）是一种允许两方基于外部事件的结果进行链下（off-chain）条件支付的协议。它的核心创意是让双方在不需要信任第三方的情况下，能够根据真实世界数据的结果来执行合约。
- 简单用途示例
  - DLC 让两个参与者可以押注某个外部事件的结果。比如说，你和朋友想赌比特币价格在某个日期是否会超过 50,000 美元。使用 DLC，你们可以创建一份合约，预先同意所有可能的结果及其对应的支付方式。然后当这个事件真实发生，合约会根据结果自动执行支付。
- 主要特点
  - 隐私性，合约的细节不会被记录到比特币区块链上，包括预言机也不知道合约相关的任何信息，只有最终的支付结果会上链。也就是说赌注内容、条件都保持私密，在链上只是一个普通的交易。
  - 预言机的弱信任模型 (Weak Trust Assumption)，预言机无法盗取资金，它只是参与签名的发布，不决定资金的转移。
  - 安全性，DLC 的安全性基于离散对数问题（Discrete Log Problem），并且数学算法决定了预言机无法部署虚假数据。

## 核心组成

### 注资输出（Funding Output）

双方注入保证金的多签 UTXO。

### 合约执行交易（CETs）

为每个可能的结果预先构造的结算交易，用来写死资金的分配。

### 预言机（Oracle）

提供区块链与外部世界之间的连接 —— 因此是被信任会提供准确数据的。

断言机并不知道合约，也不知道谁在使用他们的数据，他们根据预先确定的计划独立第发布自己的签名消息。这些签名会被 Alice 和 Bob 合并到合约中，但断言机不会察觉。

在这个过程中预言机要做的就是对某个结果的 Schnorr 签名，用来激活唯一正确的 CET。

### 适配器签名 (Adaptor Signatures) 

适配器签名是 [Schnorr 签名](https://medium.com/interdax/how-will-schnorr-signatures-benefit-bitcoin-b4482cf85d40) 的一种特殊用法

适配器签名是 DLC 的核心。它允许：

- 签名者创建一个"不完整"的签名
- 这个签名可以被验证但无法使用
- 只有知道特定密钥值的人才能完成它

## 工作流程

### 链下的设计与承诺

时间：DLC 创建前（几周/几天）

步骤 1：确定合约条件
  Alice：决定赌注内容
    • 资产：BTC
    • 条件：价格在 03-31 是否 ≥ $100k
    • 结果：二元（是/否）
    • 金额：Alice 和 Bob 各 1 BTC

  Bob：评估
    • 同意或拒绝参与
    • 提出修改（更改日期、价格等）

步骤 2：选择预言机
  共同决定：使用哪个预言机
    • Suredbits 预言机
    • Krystal Bull 预言机
    • 或多个预言机（M-of-N）

  获取预言机信息：
    • 预言机公钥
    • 预言机将如何发布数据
    • 预言机的费用（如果有）

步骤 3：等待预言机承诺
  预言机（在事件发生前）：
    ├─ 宣布将为这个事件签署
    ├─ 发布 R 值（一次性随机值）
    ├─ 签署 R 值本身，创建不可否认的承诺
    └─ 将 R 值公开发布

  Alice 和 Bob：
    ├─ 收集预言机公告
    ├─ 验证承诺的有效性
    └─ 确认无法被篡改（已签署）

### 链下的合约协议

时间：设计后，资金交易前

消息交换（3 条消息）：

消息 1：提议（Offer）- Alice → Bob

​	Alice 生成：部分签名（为两个 CET）+ 退款交易签名

消息 2：接受（Accept）- Bob → Alice

​	Bob 生成：适配器签名（为两个 CET）+ 退款交易签名 + 他的 UTXO 列表

消息 3：签名（Sign）- Alice → Bob
### 资金上链

时间：协议签署后

步骤 1：Alice 创建资金交易
  输入：
    • Alice 的 1 BTC UTXO
    • Bob 的 1 BTC UTXO

  输出：
    • 2 BTC 到 2-of-2 多重签名（Alice 和 Bob 都需要签署才能支出）

  费用：
    • 根据当前网络状况计算
    • 例如：500 sat

步骤 2：双方签署并广播
  Alice 签署：使用她的私钥签署资金交易
  Bob 签署：使用他的私钥签署资金交易

  广播：发送上链

步骤 3：挖矿确认这笔交易成功执行

### 链下等待

时间：资金交易确认后到事件发生时

Alice 和 Bob：
  • 监控 BTC 价格
  • 定期验证预言机是否在线
  • 准备在事件后立即行动

预言机：
  • 在后台监控价格数据
  • 确保数据源可用
  • 准备在事件发生时签署结果

### 链下预言机签名

时间：事件发生时（达到了当初约定好的这个时间）

步骤 1：观察事件
  预言机：记录 BTC 价格，在约定时间的最后一刻比如 BTC/USD 价格 = $102,500，结果就是：价格 ≥ $100k（是 ✓）

步骤 2：签署结果
  预言机：使用它的私钥签署消息："BTC_USD_2025-03-31:102500"，使用它之前承诺的 R 值生成签名

步骤 3：发布签名
  预言机：将签名发布到网站，或通过 Nostr 发送，或通过 API 提供，不需要发布原始价格数据而只需要发布签名

  Alice 和 Bob：获取签名并验证签名有效（使用预言机公钥），可以提取秘密来解锁适配器签名。

### 链上执行合约

时间：预言机签署后

赢家（Alice）的操作：

步骤 1：提取秘密
  Alice 从预言机签名中识别出预言机使用的 R 值，计算签名的其他参数，提取秘密值。

步骤 2：解锁适配器签名

步骤 3：构建 CET
  Alice 取出预先创建的 CET_Above 交易，添加她现在有的完整签名。

步骤 4：广播交易
  Alice：将 CET_Above 发送到比特币网络，CET_Above 支出资金交易的 2 BTC，将所有 2 BTC 发送给 Alice。

步骤 5：确认和完成
  确认：等待 1-6 个区块确认

  Alice 赢得 2 BTC
  Bob 损失 1 BTC（输掉赌注）

## DLC 与 2-3 多签的核心区别

> 因为断言机不知道使用自己数据的具体合约，它也就无法决定具体的合约的结果。这是谨慎日志合约与那些断言机以 2-3 多签名之一参与的方案的重大区别。

如果没有 DLC 的话，两方可以使用 2-of-3 多签名方案来形成一个合约。在这种情况下，两个参与者将资金锁到一个比特币多签名输出中，第三方则作为托管代理商。要从这个输出中获得资金，必须提供至少两个签名。

要是双方都同意结果，他们可以一起签名交易、结算赌约，这就不需要断言机的参与。但是，一旦有了分歧，第三方就将决定结果。

这里就会遇到**断言机问题**：托管代理可以被收买，或者说可以跟其中一个参与者勾结，在结果上作伪。这意味着，另一方即使明明赌对了，也会损失所有的资金。

所以 DLC 本质上是用密码学结构解决了断言机作恶的潜在风险。



## 使用场景和案例

**任何需要根据未来的链外数据来分割资金的情形，都可以使用谨慎日志合约**。

比如：

- 可支持的结果类型
  - 二元结果（是/否）
  - 多元结果（赤字、平、绿色）
  - 连续结果（任意价格点，数百万个可能的结果）
  - 多维结果（多个同时发生的事件）
- 金融工具
  - 期货合约
  - 期权

### 用比特币结算的远期合约（forward contract）

> 远期合约（Forward Contract）是一种场外交易（OTC）的非标准化金融衍生工具，买卖双方约定在未来特定时间以今日商定的价格（即期交货价格）交割一定数量的资产。它主要用于对冲风险（如外汇或商品价格风险）或投机，具有量身定制、流动性较差、无监管和违约风险较高等特点。核心特征与机制：
>
> - **场外交易（OTC）：** 不在交易所交易，而是直接在交易双方之间私下签署。
> - **非标准化：** 合约内容（金额、期限、交割方式）可根据需求定制，而非标准化合约。
> - **交割方式：** 通常到期时进行实物交割，也可以进行现金结算。
> - **费用与结算：** 合约签署时一般没有初次成本，不实行每日盯市结算（不需缴纳保证金）。
> - **风险：** 具有较高的交易对手信用风险（Counterparty Risk），即一方可能违约。
>
> **远期与期货的区别**
>
> | 特征         | 远期合约 (Forward)   | 期货合约 (Futures)   |
> | :----------- | :------------------- | :------------------- |
> | **交易场所** | 场外交易 (OTC)       | 交易所               |
> | **标准化**   | 非标准化（量身定制） | 标准化合约           |
> | **成交价格** | 远期价格             | 期货价格（每日浮动） |
> | **违约风险** | 高（取决于交易对手） | 低（由结算所担保）   |
> | **交易成本** | 主要是买卖差价       | 佣金和保证金         |

两方之间约定在未来某个时间以特定价格买入或卖出所有资产的定制化合约.

远期合约是很常见的对冲资金价格波动性的工具。使用美元远期合约，你就能对冲美元和比特币的汇率波动。

你也可以创建其它资产，比如黄金、小麦、咖啡的远期合约。只要有断言机发布价格数据，你就可以用谨慎日志合约来设立远期合约。

#### 案例

- 事件：Alice 和 Bob 约定在未来一个具体的时间（比如 2026.03.20 这一天）根据市场价格执行一笔交易（双向对赌价格变动）

  - Alice
    - 动机：比如可能是因为她有需要用美元支付的债务，希望对冲汇率的波动，她参与这份合约的理由是因为她觉得 BTC 有可能会跌。
    - 行为：Alice 同意以 12500 聪（即 0.000125 BTC）/美元 的价格（相当于 8000 美元：1 比特币）在 3.20 这一天卖出 BTC。
    - 未来的结果：到  3.20 这一天，无论当时的美元-比特币汇率到底是多少，Alice 都可以卖出她的 btc 获得 5000 美元。
  - Bob 
    - 动机：预期 btc 价格会涨，他希望通过这个赚钱。
    - 行为：Bob 同意用 5000 美元买入 Alice 的 BTC。
    - 未来结果：交易成交。

- 前提

  - Alice 和 Bob 各自承诺一笔资金，作为预付金。这些资金会锁在一个 2-2 的多签名输出中，由 Alice 和 Bob 的私钥共同控制。在锁定资金之前，他们先交换一笔交易，该交易可根据断言机宣布的价格花费锁定的资金。（译者注：锁定的资金表现为一个 2-2 的多签名输出，因此，双方都各自生成一笔花费其中自己的交易，签上自己的签名，提交给对方。由此，双方都拿到了对方的签名，加上自己的签名就是一笔完整、有效的交易，可以花费锁定的资金。）

    因此，在承诺资金之前，双方就已经知道了他们有权获得的资金是可以取出的。这也意味着支付额仅限于双方同意在合约中锁定的金额。

- 逻辑

  - 因为这个合约是以比特币来结算的，就像普通资产远期合约以现金计价一样，Bob 不必真的把美元交给 Alice，失利的一方只需用比特币来支付约定价格和市场价格之间的差额。（到期时按市场价与约定价的差额**用 BTC 结算**）
  - 所以，如果美元升值，Bob 就要给 Alice 支付价差；类似地，如果美元贬值，那 Alice 就要给 Bob 支付。

- 具体分析：

  - 约定价（行权价/结算价）= 12500 sat/USD（=1 BTC 8000 USD），名义本金=5000 USD；

  - 为保证任何一方最大亏损可覆盖价差，双方各锁定保证金=5000×12500=62,500,000 sat（ 0.625 BTC），总锁定=1.25 BTC。

    到期预言机给现价：

    若仍是 12500，则价差=0，Alice=0.625、Bob=0.625；

    若现价=14000，则 Bob 付价差=5000×(14000-12500)=7,500,000 sat=0.075 BTC 给 Alice，结算后 Alice=0.700、Bob=0.550；

    若现价=11000，则 Alice 付价差=5000×(12500-11000)=0.075 BTC 给 Bob，结算后 Alice=0.550、Bob=0.700；

    若现价≥25000，则 Bob 需要付的价差≥0.625 BTC，刚好吃掉他的全部保证金，Alice 拿走全部 1.25 BTC，再高就出现“保证金不足以覆盖价差”的风险。

- 执行流程
  - **选断言机**：双方先选一个会在未来公布价格的预言机，并拿到它的公钥。
  - **先设计所有结算结果**：在钱真正锁上链之前，Alice 和 Bob 就为“每一个可能价格”提前构造好对应的结算交易（CET），这些交易写死未来资金如何分配，并互相交换签名。
  - **确认能拿回钱 → 才锁资金**：等双方都确认自己已经握有“能在任何结果下拿钱的交易”，才共同签名充值交易，把各自 0.625 BTC 锁进一个 2-of-2 输出。
  - **等待结果**：合约到期，断言机公布价格并签名。
  - **广播正确的结算交易**：任何一方拿着断言机签名，就能广播对应价格的 CET，链上自动按那一条分支把钱分掉。

- 如何防止作弊
	- 如果有人广播了错误价格对应的 CET，对方在超时后可以把全部钱拿走；
	- 如果赢的一方不动作，输的一方等超时也能收走资金。

## 落地限制因素

> 其实 DLC 是一个相对而言不那么复杂的协议了，并且在所依赖的技术（Schnorr 签名、适配器签名、多重签名脚本）上成熟度和可行性很高，但是为什么目前还是没有很成熟的落地场景呢？

- 工程复杂度
  - 需要钱包支持 adaptor signature、CET 管理、预言机监听等。
- 用户体验
  - 整个过程中的交互流程比较繁琐，签名场景多。
- 预言机
  - 比特币生态缺乏稳定安全可用的预言机
- 流动性劣势
  - 点对点合约难以形成深度
- 监管敏感
  - 预测市场、衍生品、博彩在多数司法辖区高度受限，创业团队更倾向走托管或半中心化路径。



